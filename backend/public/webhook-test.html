<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wise Webhook Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .response {
            margin-top: 20px;
        }

        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-success {
            background: #10b981;
            color: white;
        }

        .status-error {
            background: #ef4444;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: #1e40af;
            font-size: 14px;
            line-height: 1.6;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîî Wise Webhook Tester</h1>
            <p class="subtitle">Test your webhook endpoint in real-time with custom payloads and event types</p>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2>üìã Configure Test</h2>

                <div class="info-box">
                    <p><strong>Webhook URL:</strong><br>
                    <code>/api/wise/webhook</code></p>
                </div>

                <div class="form-group">
                    <label for="eventType">Event Type</label>
                    <select id="eventType">
                        <option value="test">Test Event (webhook#test)</option>
                        <option value="balances#credit">Account Deposit (balances#credit)</option>
                        <option value="transfers#state-change">Transfer Update (transfers#state-change)</option>
                        <option value="transfers#active-cases">Transfer Issue (transfers#active-cases)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="webhookSecret">Webhook Secret (Optional)</label>
                    <input type="password" id="webhookSecret" placeholder="Leave empty to skip signature">
                    <small style="color: #666; font-size: 12px;">If provided, will calculate HMAC-SHA256 signature</small>
                </div>

                <div class="button-group">
                    <button class="btn-primary" onclick="sendWebhook()">
                        üöÄ Send Test Webhook
                    </button>
                    <button class="btn-secondary" onclick="clearResponse()">
                        üóëÔ∏è Clear
                    </button>
                </div>
            </div>

            <div class="card">
                <h2>üì§ Request Payload</h2>
                <div id="requestPayload" class="code-block">
                    Select an event type to see the payload
                </div>
            </div>

            <div class="card full-width">
                <h2>üì• Response</h2>
                <div id="response">
                    <p style="color: #999;">Send a test webhook to see the response...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const eventPayloads = {
            'test': {
                event_type: 'test',
                data: {
                    message: 'Test webhook from webhook tester'
                }
            },
            'balances#credit': {
                event_type: 'balances#credit',
                data: {
                    resource: {
                        id: 'test_transaction_' + Date.now(),
                        type: 'transaction'
                    },
                    amount: {
                        value: 1500.00,
                        currency: 'EUR'
                    },
                    profile_id: '74801255',
                    account_id: 'balance_test',
                    state: 'completed',
                    created_time: new Date().toISOString(),
                    details: {
                        description: 'Test deposit - Webhook Tester',
                        merchant_name: 'Test Merchant',
                        reference: 'TEST-' + Date.now()
                    }
                }
            },
            'transfers#state-change': {
                event_type: 'transfers#state-change',
                data: {
                    resource: {
                        id: 'test_transfer_' + Date.now(),
                        type: 'transfer'
                    },
                    transfer_id: 'test_transfer_' + Date.now(),
                    current_state: 'outgoing_payment_sent',
                    previous_state: 'processing',
                    occurred_at: new Date().toISOString()
                }
            },
            'transfers#active-cases': {
                event_type: 'transfers#active-cases',
                data: {
                    resource: {
                        id: 'test_transfer_' + Date.now(),
                        type: 'transfer'
                    },
                    transfer_id: 'test_transfer_' + Date.now(),
                    case_type: 'test_issue',
                    details: {
                        message: 'Test transfer issue from webhook tester',
                        reason: 'Testing error handling'
                    }
                }
            }
        };

        // Update payload preview when event type changes
        document.getElementById('eventType').addEventListener('change', function() {
            updatePayloadPreview();
        });

        function updatePayloadPreview() {
            const eventType = document.getElementById('eventType').value;
            const payload = eventPayloads[eventType];
            document.getElementById('requestPayload').textContent = JSON.stringify(payload, null, 2);
        }

        // Initialize with test event payload
        updatePayloadPreview();

        async function calculateSignature(payload, secret) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(secret);
            const messageData = encoder.encode(payload);

            const key = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );

            const signature = await crypto.subtle.sign(
                'HMAC',
                key,
                messageData
            );

            return Array.from(new Uint8Array(signature))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        async function sendWebhook() {
            const eventType = document.getElementById('eventType').value;
            const webhookSecret = document.getElementById('webhookSecret').value;
            const payload = eventPayloads[eventType];

            // Show loading state
            document.getElementById('response').innerHTML = `
                <div class="status status-pending">
                    Sending... <div class="spinner"></div>
                </div>
            `;

            try {
                const payloadString = JSON.stringify(payload);
                const headers = {
                    'Content-Type': 'application/json'
                };

                // Calculate signature if secret provided
                if (webhookSecret) {
                    const signature = await calculateSignature(payloadString, webhookSecret);
                    headers['x-signature'] = signature;
                }

                const startTime = Date.now();
                const response = await fetch('/api/wise/webhook', {
                    method: 'POST',
                    headers: headers,
                    body: payloadString
                });

                const elapsed = Date.now() - startTime;
                const responseData = await response.json();

                // Display response
                const statusClass = response.ok ? 'status-success' : 'status-error';
                const statusText = response.ok ? 'SUCCESS' : 'ERROR';

                document.getElementById('response').innerHTML = `
                    <div class="status ${statusClass}">
                        ${statusText} - ${response.status} ${response.statusText} (${elapsed}ms)
                    </div>
                    <h3 style="margin-top: 20px; margin-bottom: 10px;">Response Body:</h3>
                    <div class="code-block">${JSON.stringify(responseData, null, 2)}</div>

                    <h3 style="margin-top: 20px; margin-bottom: 10px;">Request Headers Sent:</h3>
                    <div class="code-block">${JSON.stringify(headers, null, 2)}</div>
                `;

            } catch (error) {
                document.getElementById('response').innerHTML = `
                    <div class="status status-error">
                        NETWORK ERROR
                    </div>
                    <div class="code-block">${error.message}</div>
                `;
            }
        }

        function clearResponse() {
            document.getElementById('response').innerHTML = `
                <p style="color: #999;">Send a test webhook to see the response...</p>
            `;
        }
    </script>
</body>
</html>
